<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>Ouroboros.Consensus.Storage.VolatileDB.Impl</title><link href="ocean.css" rel="stylesheet" type="text/css" title="Ocean" /><link rel="stylesheet" type="text/css" href="quick-jump.css" /><script src="haddock-bundle.min.js" async="async" type="text/javascript"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type="text/javascript"></script></head><body><div id="package-header"><ul class="links" id="page-menu"><li><a href="src/Ouroboros.Consensus.Storage.VolatileDB.Impl.html">Source</a></li><li><a href="&quot;../index.html&quot;">Contents</a></li><li><a href="doc-index.html">Index</a></li></ul><p class="caption">ouroboros-consensus-0.1.0.0: Consensus layer for the Ouroboros blockchain protocol</p></div><div id="content"><div id="module-header"><table class="info"><tr><th>Safe Haskell</th><td>None</td></tr><tr><th>Language</th><td>Haskell2010</td></tr></table><p class="caption">Ouroboros.Consensus.Storage.VolatileDB.Impl</p></div><div id="table-of-contents"><p class="caption">Contents</p><ul><li><a href="#g:1">Opening a database</a></li></ul></div><div id="description"><p class="caption">Description</p><div class="doc"><p>Volatile on-disk database of binary blobs</p><h1>Logic</h1><p>The db is a key-value store of binary blocks and is parametric on the key
 of blocks, named <code>blockId</code>.</p><p>The database uses in-memory indexes, which are created on each (re)opening.
 Reopening includes parsing all blocks in the <code>dbFolder</code>, so it can be an
 expensive operation if the database gets big. That's why the intention of
 this db is to be used for only the tip of the blockchain, when there is
 still volatility on which blocks are included. The db is agnostic to the
 format of the blocks, so a parser must be provided. In addition to
 <code>getBlock</code> and <code><a href="Ouroboros-Consensus-Storage-VolatileDB-API.html#v:putBlock" title="Ouroboros.Consensus.Storage.VolatileDB.API">putBlock</a></code>, the db provides also the ability to
 garbage-collect old blocks. The actual garbage-collection happens in terms
 of files and not blocks: a file is deleted/garbage-collected if all blocks
 in it have a slot number less than the slot number for which garbage
 collection was triggered. This type of garbage collection makes the
 deletion of blocks depend on the number of blocks we insert in each file,
 as well as the order of insertion, so it's not deterministic on blocks
 themselves.</p><h1>Errors</h1><p>When an exception occurs while modifying the db, we close the database as a
 safety measure, e.g., in case a file could not be written to disk, as we
 can no longer make sure the in-memory indices match what's stored on the
 file system. When reopening, we validate the blocks stored in the file
 system and reconstruct the in-memory indices.</p><p>NOTE: this means that when a thread modifying the db is killed, the db will
 close. This is an intentional choice to simplify things.</p><p>The in-memory indices can always be reconstructed from the file system.
 This is important, as we must be resilient against unexpected shutdowns,
 power losses, etc.</p><p>We achieve this by only performing basic operations on the db:
 * <code><a href="Ouroboros-Consensus-Storage-VolatileDB-API.html#v:putBlock" title="Ouroboros.Consensus.Storage.VolatileDB.API">putBlock</a></code> only appends a new block on a file. Losing an update means we
   only lose a block, which can be recovered.
 * <code><a href="Ouroboros-Consensus-Storage-VolatileDB-API.html#v:garbageCollect" title="Ouroboros.Consensus.Storage.VolatileDB.API">garbageCollect</a></code> only deletes whole files.
 * there is no operation that modifies blocks. Thanks to that we need not
   keep any rollback journals to make sure we are safe in case of unexpected
   shutdowns.</p><p>We only throw <code><a href="Ouroboros-Consensus-Storage-VolatileDB-Types.html#t:VolatileDBError" title="Ouroboros.Consensus.Storage.VolatileDB.Types">VolatileDBError</a></code>. File-system errors, are caught, wrapped in
 a <code><a href="Ouroboros-Consensus-Storage-VolatileDB-Types.html#t:VolatileDBError" title="Ouroboros.Consensus.Storage.VolatileDB.Types">VolatileDBError</a></code>, and rethrown. We must make sure that all calls to
 <code><a href="Ouroboros-Consensus-Storage-FS-API.html#t:HasFS" title="Ouroboros.Consensus.Storage.FS.API">HasFS</a></code> functions are properly wrapped. This wrapping is automatically done
 when inside the scope of <code>modifyOpenState</code> and <code><a href="Ouroboros-Consensus-Storage-VolatileDB-Impl-State.html#v:withOpenState" title="Ouroboros.Consensus.Storage.VolatileDB.Impl.State">withOpenState</a></code>. Otherwise,
 use <code><a href="Ouroboros-Consensus-Storage-VolatileDB-Impl-Util.html#v:wrapFsError" title="Ouroboros.Consensus.Storage.VolatileDB.Impl.Util">wrapFsError</a></code>.</p><h1>Concurrency</h1><p>The same db should only be opened once. Multiple threads can share the same
 db as concurency is fully supported.</p><h1>FS Layout:</h1><p>The on-disk representation is as follows:</p><pre>dbFolder/
  blocks-0.dat
  blocks-1.dat
  ...</pre><p>Files not fitting the naming scheme are ignored. The numbering of these
 files does not correlate to the blocks stored in them.</p><p>Each file stores a fixed number of blocks, specified by <code><a href="Ouroboros-Consensus-Storage-VolatileDB-Impl.html#t:VolatileDbArgs" title="Ouroboros.Consensus.Storage.VolatileDB.Impl">VolatileDbArgs</a></code>.
 If the db finds files with less blocks than this limit, it will start
 appending to the newest of them if there are no newer full files. Otherwise
 it will create a new file.</p><p>There is an implicit ordering of block files, which is NOT alpharithmetic
 For example blocks-20.dat &lt; blocks-100.dat</p><h1>Recovery</h1><p>The VolatileDB will always try to recover to a consistent state even if this
 means deleting all of its contents. In order to achieve this, it truncates
 the files containing blocks if some blocks fail to parse, are invalid, or are
 duplicated.</p></div></div><div id="synopsis"><details id="syn"><summary>Synopsis</summary><ul class="details-toggle" data-details-id="syn"><li class="src short"><a href="#v:openDB">openDB</a> &#8759; (<a href="Ouroboros-Consensus-Util-CallStack.html#t:HasCallStack" title="Ouroboros.Consensus.Util.CallStack">HasCallStack</a>, <a href="Ouroboros-Consensus-Util-IOLike.html#t:IOLike" title="Ouroboros.Consensus.Util.IOLike">IOLike</a> m, <a href="file:///opt/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/Data-Ord.html#t:Ord" title="Data.Ord">Ord</a> blockId, <a href="Ouroboros-Consensus-Util-IOLike.html#t:NoUnexpectedThunks" title="Ouroboros.Consensus.Util.IOLike">NoUnexpectedThunks</a> blockId, <a href="file:///opt/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/Data-Eq.html#t:Eq" title="Data.Eq">Eq</a> h) &#8658; <a href="Ouroboros-Consensus-Storage-VolatileDB-Impl.html#t:VolatileDbArgs" title="Ouroboros.Consensus.Storage.VolatileDB.Impl">VolatileDbArgs</a> m h blockId e &#8594; m (<a href="Ouroboros-Consensus-Storage-VolatileDB-API.html#t:VolatileDB" title="Ouroboros.Consensus.Storage.VolatileDB.API">VolatileDB</a> blockId m)</li><li class="src short"><span class="keyword">data</span> <a href="#t:VolatileDbArgs">VolatileDbArgs</a> m h blockId e = <a href="#v:VolatileDbArgs">VolatileDbArgs</a> {<ul class="subs"><li><a href="#v:hasFS">hasFS</a> &#8759; <a href="Ouroboros-Consensus-Storage-FS-API.html#t:HasFS" title="Ouroboros.Consensus.Storage.FS.API">HasFS</a> m h</li><li><a href="#v:maxBlocksPerFile">maxBlocksPerFile</a> &#8759; <a href="Ouroboros-Consensus-Storage-VolatileDB-Types.html#t:BlocksPerFile" title="Ouroboros.Consensus.Storage.VolatileDB.Types">BlocksPerFile</a></li><li><a href="#v:tracer">tracer</a> &#8759; <a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/contra-tracer-0.1.0.0/noopt/doc/html/contra-tracer/Control-Tracer.html#t:Tracer" title="Control.Tracer">Tracer</a> m (<a href="Ouroboros-Consensus-Storage-VolatileDB-Types.html#t:TraceEvent" title="Ouroboros.Consensus.Storage.VolatileDB.Types">TraceEvent</a> e blockId)</li><li><a href="#v:parser">parser</a> &#8759; <a href="Ouroboros-Consensus-Storage-VolatileDB-Types.html#t:Parser" title="Ouroboros.Consensus.Storage.VolatileDB.Types">Parser</a> e m blockId</li><li><a href="#v:prefixLen">prefixLen</a> &#8759; <a href="Ouroboros-Consensus-Storage-Common.html#t:PrefixLen" title="Ouroboros.Consensus.Storage.Common">PrefixLen</a></li></ul>}</li></ul></details></div><div id="interface"><a href="#g:1" id="g:1"><h1>Opening a database</h1></a><div class="top"><p class="src"><a id="v:openDB" class="def">openDB</a> &#8759; (<a href="Ouroboros-Consensus-Util-CallStack.html#t:HasCallStack" title="Ouroboros.Consensus.Util.CallStack">HasCallStack</a>, <a href="Ouroboros-Consensus-Util-IOLike.html#t:IOLike" title="Ouroboros.Consensus.Util.IOLike">IOLike</a> m, <a href="file:///opt/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/Data-Ord.html#t:Ord" title="Data.Ord">Ord</a> blockId, <a href="Ouroboros-Consensus-Util-IOLike.html#t:NoUnexpectedThunks" title="Ouroboros.Consensus.Util.IOLike">NoUnexpectedThunks</a> blockId, <a href="file:///opt/ghc/8.6.5/share/doc/ghc-8.6.5/html/libraries/base-4.12.0.0/Data-Eq.html#t:Eq" title="Data.Eq">Eq</a> h) &#8658; <a href="Ouroboros-Consensus-Storage-VolatileDB-Impl.html#t:VolatileDbArgs" title="Ouroboros.Consensus.Storage.VolatileDB.Impl">VolatileDbArgs</a> m h blockId e &#8594; m (<a href="Ouroboros-Consensus-Storage-VolatileDB-API.html#t:VolatileDB" title="Ouroboros.Consensus.Storage.VolatileDB.API">VolatileDB</a> blockId m) <a href="src/Ouroboros.Consensus.Storage.VolatileDB.Impl.html#openDB" class="link">Source</a> <a href="#v:openDB" class="selflink">#</a></p></div><div class="top"><p class="src"><span class="keyword">data</span> <a id="t:VolatileDbArgs" class="def">VolatileDbArgs</a> m h blockId e <a href="src/Ouroboros.Consensus.Storage.VolatileDB.Impl.html#VolatileDbArgs" class="link">Source</a> <a href="#t:VolatileDbArgs" class="selflink">#</a></p><div class="subs constructors"><p class="caption">Constructors</p><table><tr><td class="src"><a id="v:VolatileDbArgs" class="def">VolatileDbArgs</a></td><td class="doc empty">&nbsp;</td></tr><tr><td colspan="2"><div class="subs fields"><p class="caption">Fields</p><ul><li><dfn class="src"><a id="v:hasFS" class="def">hasFS</a> &#8759; <a href="Ouroboros-Consensus-Storage-FS-API.html#t:HasFS" title="Ouroboros.Consensus.Storage.FS.API">HasFS</a> m h</dfn><div class="doc empty">&nbsp;</div></li><li><dfn class="src"><a id="v:maxBlocksPerFile" class="def">maxBlocksPerFile</a> &#8759; <a href="Ouroboros-Consensus-Storage-VolatileDB-Types.html#t:BlocksPerFile" title="Ouroboros.Consensus.Storage.VolatileDB.Types">BlocksPerFile</a></dfn><div class="doc empty">&nbsp;</div></li><li><dfn class="src"><a id="v:tracer" class="def">tracer</a> &#8759; <a href="file:///__w/ouroboros-network/ouroboros-network/dist-newstyle/build/x86_64-linux/ghc-8.6.5/contra-tracer-0.1.0.0/noopt/doc/html/contra-tracer/Control-Tracer.html#t:Tracer" title="Control.Tracer">Tracer</a> m (<a href="Ouroboros-Consensus-Storage-VolatileDB-Types.html#t:TraceEvent" title="Ouroboros.Consensus.Storage.VolatileDB.Types">TraceEvent</a> e blockId)</dfn><div class="doc empty">&nbsp;</div></li><li><dfn class="src"><a id="v:parser" class="def">parser</a> &#8759; <a href="Ouroboros-Consensus-Storage-VolatileDB-Types.html#t:Parser" title="Ouroboros.Consensus.Storage.VolatileDB.Types">Parser</a> e m blockId</dfn><div class="doc empty">&nbsp;</div></li><li><dfn class="src"><a id="v:prefixLen" class="def">prefixLen</a> &#8759; <a href="Ouroboros-Consensus-Storage-Common.html#t:PrefixLen" title="Ouroboros.Consensus.Storage.Common">PrefixLen</a></dfn><div class="doc empty">&nbsp;</div></li></ul></div></td></tr></table></div></div></div></div><div id="footer"><p>Produced by <a href="http://www.haskell.org/haddock/">Haddock</a> version 2.22.0</p></div></body></html>